{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>TeamLock | {% trans "Installation" %}</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="{% static 'plugins/font-awesome/css/font-awesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'stylesheets/AdminLTE.min.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/smartWizard/smartWizard.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/select2/select2.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/switchery/switchery.min.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/pnotify/pnotify.min.css' %}">
    <link rel="stylesheet" href="{% static 'stylesheets/style.css' %}">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body class="hold-transition login-page">
    <div class="login-box" id="first-box">
    	<div class="login-logo">
	        <span id="load"><i class="fa fa-gears fa-2x"></i></span><br/>
	        <a href="/"><b>TeamLock</b> {% trans "Installation" %}</a>
	    </div>

	    <div class="row">
	    	<div id="wizard" class="swMain">
	  			<ul>
	  				<li>
	  					<a href="#step-1">
			                <span class="StepTitle"><i class="fa fa-cog"></i>&nbsp;&nbsp;{% trans "General" %}</span>
		            	</a>
		            </li>
		  			<li>
		  				<a href="#step-2">
			                <span class="StepTitle"><i class="fa fa-key"></i>&nbsp;&nbsp;{% trans "Security" %}</span>
		            	</a>
		            </li>
		  			<li>
		  				<a href="#step-3">
			                <span class="StepTitle"><i class="fa fa-envelope"></i>&nbsp;&nbsp;{% trans "Mail" %}</span>
		             	</a>
		             </li>
		             <li>
		  				<a href="#step-4">
			                <span class="StepTitle"><i class="fa fa-user"></i>&nbsp;&nbsp;{% trans "Administrator" %}</span>
		             	</a>
		             </li>

	  			</ul>
		  		<div id="step-1">	
		       		<div class="box">
		       			<div class="box-header with-border">
			             	<i class="fa fa-cog"></i>
			            	<h3 class="box-title">{% trans "General Settings" %}</h3>
			            </div>
			            <div class="box-body">
			            	<div class="row">
								<div class="col-sm-12">
									<label for="id_company_name">{{ general.company_name.label }}</label>
									{{ general.company_name }}
									<p class="error_form">{{ general.company_name.errors }}</p>
								</div>
							</div>

							<div class="row">
								<div class="col-md-3">
									<label for="id_archives">{{ cloud.archives.label }}</label>&nbsp;
									{{ cloud.archives }}
									<p class="error_form">{{ cloud.archives.errors }}</p>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6">
									<label for="id_path_cloud">{{ cloud.path_cloud.label }}</label>
									{{ cloud.path_cloud }}
									<p class="error_form">{{ cloud.path_cloud.errors }}</p>
								</div>
								<div class="col-md-6">
									<label for="id_max_space">{{ cloud.max_space.label }}</label>
									{{ cloud.max_space }}
									<p class="error_form">{{ cloud.max_space.errors }}</p>
								</div>
							</div>
			            </div>
		       		</div>
		       
		        </div>
		  		<div id="step-2">
		            <div class="box">
		       			<div class="box-header with-border">
			             	<i class="fa fa-key"></i>
			            	<h3 class="box-title">{% trans "Security Settings" %}</h3>
			            </div>
			            <div class="box-body">
			            	<div class="row">
								<div class="col-md-6 col-sm-12">
									<label for="id_password_change">{{ security.password_change.label }}</label>
									{{ security.password_change }}
									<p class="error_form">{{ security.password_change.errors }}</p>
								</div>
								<div class="col-md-6 col-sm-12">
									<label for="id_length_password">{{ security.length_password.label }}</label>
									{{ security.length_password }}
									<p class="error_form">{{ security.length_password.errors }}</p>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6 col-sm-12">
									<label for="id_key_size">{{ security.key_size.label }}</label>
									{{ security.key_size }}
									<p class="error_form">{{ security.key_size.errors }}</p>
								</div>
								<div class="col-md-6 col-sm-12">
									<label for="id_key_size">{% trans "Backup password" %}</label>
									<input type="password" class="form-control" name="backup_password" id="id_backup_password"/>
									<small id="emailHelp" class="form-text text-muted">
										{% trans "Password used with the API to backup all Workspaces" %}
									</small>
								</div>
							</div>
			            </div>
		       		</div>
		        </div>                      
		  		<div id="step-3">
					<div class="box">
		       			<div class="box-header with-border">
			             	<i class="fa fa-envelope"></i>
			            	<h3 class="box-title">{% trans "Mail Settings" %}</h3>
			            	<div class="box-tools pull-right">
				            	<button type="button" class="btn btn-warning btn-flat btn-xs" data-toggle="modal" data-target="#modal">{% trans "Test send mail" %}</button>
							</div>
			            </div>
			            <div class="box-body">
			            	<input type="hidden" id="mail_configured" value="1"/>
			            	<div class="row">
								<div class="col-md-12 col-sm-12">
									<label for="id_host">{{ mail.host.label }}</label>
									{{ mail.host }}
									<p class="error_form">{{ mail.host.errors }}</p>
								</div>
							</div>
			            </div>
		       		</div>				          
		        </div>

		        <div id="step-4">
		        	<div class="box">
		       			<div class="box-header with-border">
			             	<i class="fa fa-user"></i>
			            	<h3 class="box-title">{% trans "Administrator" %}</h3>
			            </div>
			            <div class="box-body">
			            	<div class="row">
					            <div class="col-md-6">
					              <div class="form-group has-feedback">
					                <label>{% trans "First name" %}</label>
					                <input type="first_name" class="form-control" id="first_name" name="first_name">
					                <span class="glyphicon glyphicon-user form-control-feedback"></span>
					              </div>
					            </div>
					            <div class="col-md-6">
					              <div class="form-group has-feedback">
					                <label>{% trans "Last name" %}</label>
					                <input type="last_name" class="form-control" id="last_name" name="last_name">
					                <span class="glyphicon glyphicon-user form-control-feedback"></span>
					              </div>
					            </div>
					        </div>

					        <div class="row">
					            <div class="col-md-12">
					              <div class="form-group has-feedback">
					                <label>{% trans "Email address" %}</label>
					                <input type="email" class="form-control" id="email" name="email">
					                <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
					              </div>
					            </div>
					        </div>

					        <div class="row">
					            <div class="col-md-6">
					              <div class="form-group has-feedback">
					                <label>{% trans "Password" %}</label>
					                <input type="password" class="form-control" id="password" name="password">
					                <span class="glyphicon glyphicon-lock form-control-feedback"></span>
					              </div>
					            </div>
					            <div class="col-md-6">
					              <div class="form-group has-feedback">
					                <label>{% trans "Confirm password" %}</label>
					                <input type="password" class="form-control" id="repassword" name="repassword">
					                <span class="glyphicon glyphicon-lock form-control-feedback"></span>
					              </div>
					            </div>
					        </div>
			            </div>
		       		</div>
		        </div>
		    </div>
  		</div>
		
		<div class="modal fade" tabindex="-1" id="modal" role="dialog">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title">Recipient</h4>
		      </div>
		      <div class="modal-body">
		      		<div class="row">
		      			<div class="col-md-12">
			      			<label for="to">Recipient</label>
			      			<input type="email" id="to" class="form-control"/>
		      			</div>
		      		</div>
		      		<div class="row ring-div">
		      			<img class='ring' id="ring-mail" src="{% static 'images/ring.svg' %}"/>
		      		</div>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-flat btn-warning" data-dismiss="modal">Close</button >
		        <button type="button" class="form-submit btn-flat btn btn-success" id="test_send_mail">Send</button>
		      </div>
		    </div>
		  </div>
		</div>

    </div>

    <script src="{% static 'plugins/jQuery/jquery-2.2.3.min.js' %}"></script>
    <script src="{% static 'plugins/bootstrap/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'plugins/switchery/switchery.min.js' %}"></script>
    <script src="{% static 'plugins/smartWizard/jquery.smartWizard.js' %}"></script>
    <script src="{% static 'plugins/pnotify/pnotify.min.js' %}"></script>
    <script src="{% static 'plugins/select2/select2.full.js' %}"></script>

    <script>

    	function notify(type, title, message){
    		PNotify.removeAll();
			new PNotify({
				title   : title,
				text    : message,
				type    : type,
				nonblock: {
					nonblock: true
				}
			})
        }

    	function leaveAStepCallback(obj, context){
	        if (context.fromStep > context.toStep){
	        	$('.buttonNext').show();
				$('.buttonFinish').hide();
				return true;
	        }

	        return validateSteps(context.fromStep); 
		}

		function validateSteps(stepnumber){
			switch (stepnumber) {
				case 1:
					break;
				case 2:
					if (parseInt($('#id_key_size').val()) < 4096){
						if (!confirm('{% trans "For maximum security, we advise for at least a 4096b RSA key" %}'))
							return false;
					}
					break;
				case 3:
					if ($('#mail_configured').val() === "0"){
						notify('error', 'Error', '{% trans "Test the mail configuration before saving." %}')
						return false;
					}

					$('.buttonNext').hide();
					$('.buttonFinish').show();
					break;
				case 4:
					var first_name   = $('#first_name').val();
					var last_name    = $('#last_name').val();
					var email        = $('#email').val();
					var password     = $('#password').val();
					var repassword   = $('#repassword').val();

					if (email === ""){
						notify('error', 'Error', '{% trans "Email needed" %}')
						return false;
					}

					if (password === ""){
						notify('error', 'Error', '{% trans "Password needed" %}')
						return false;
					}

					if (password != repassword){
						notify('error', 'Error', '{% trans "Password mismatch" %}')
						return false;
					}

					break;

			}
		
			return true;
		}

		function finishInstallCallback(objs, context){
			if (!validateSteps(4))
				return false;

			$('#load').html('<i class="fa fa-spinner fa-spin fa-2x"></i>');

			$.post(
				'/install/',
				{
					'company_name'   : $('#id_company_name').val(),
					'key_size'       : $('#id_key_size').val(),
					'password_change': $('#id_password_change').val(),
					'length_password': $('#id_length_password').val(),
					'host'           : $('#id_host').val(),
					'first_name'     : $('#first_name').val(),
					'last_name'      : $('#last_name').val(),
					'email'          : $('#email').val(),
					'password'       : $('#password').val(),
					'repassword'     : $('#repassword').val(),
					'backup_password': $('#id_backup_password').val()
				},

				function(response){
					$('#load').html('<i class="fa fa-gears fa-2x"></i>');
					if (!response['status']){
						notify('error', 'Error', response['error']);
					} else {
						notify('success', 'Success', '{% trans "Successfull installation" %}');
						setTimeout(function(){
							window.location.href = "/";
						}, 1000)
					}
				}

			)
		}

    	$(function(){
    		$('#wizard').smartWizard({
		        onLeaveStep: leaveAStepCallback,
		        onFinish: finishInstallCallback
		    });

    		var elem = document.querySelectorAll('.js-switch');
	        for (i in elem)
	        	var init = new Switchery(elem[i]);

	    	$('.select2').select2();
	        $('#id_enabled').on('change', function(){
	        	if ($(this).is(':checked'))
	        		$('.log-info').show();
	        	else
		        	$('.log-info').hide();
	        })
	    	
	    	$('#test_send_mail').on('click', function(){
	    		$('#ring-mail').show();

				var data = {
					'host': $('#id_host').val(),
					'to': $('#to').val()
				}

				$.post(
					'/sendmail/test',
					data,

					function(response){
			    		$('#ring-mail').hide();
	                    $('#modal').modal("hide");

						if (!response['status']){
							$('#mail_configured').val('0');
							notify('error', 'Error', response['error']);
						} else{
							notify('success', 'Success', '{% trans "Mail successfully sent !" %}');
							$('#mail_configured').val('1');
						}
					}
				)
			})
    	})

    </script>
  </body>
</html>
